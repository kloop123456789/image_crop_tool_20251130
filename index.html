<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒåˆ‡ã‚ŠæŠœããƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f0f0;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8e8ff;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }

        .editor-section {
            display: none;
            padding: 40px;
        }

        .editor-section.active {
            display: block;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            margin: 0 auto 30px;
            display: flex;
            justify-content: center;
        }

        #canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: move;
        }

        .crop-overlay {
            position: absolute;
            border: 3px solid #667eea;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
        }

        .resize-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
        }

        .handle-nw { top: -10px; left: -10px; cursor: nw-resize; }
        .handle-ne { top: -10px; right: -10px; cursor: ne-resize; }
        .handle-sw { bottom: -10px; left: -10px; cursor: sw-resize; }
        .handle-se { bottom: -10px; right: -10px; cursor: se-resize; }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .aspect-ratio-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .ratio-btn {
            padding: 12px 30px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ratio-btn:hover {
            background: #f0f0ff;
        }

        .ratio-btn.active {
            background: #667eea;
            color: white;
        }

        .position-controls {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .position-label {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .preview-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .preview-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .preview-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .preview-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
            text-align: center;
        }

        .preview-canvas {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f0f0ff;
        }

        .size-display {
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
            text-align: center;
        }

        .filename-input-group {
            margin-bottom: 20px;
            text-align: center;
        }

        .filename-input-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 1em;
        }

        .filename-input-group input {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 1em;
            width: 100%;
            max-width: 400px;
            outline: none;
            transition: all 0.3s ease;
        }

        .filename-input-group input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filename-input-group input::placeholder {
            color: #999;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            header {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .upload-section, .editor-section {
                padding: 20px;
            }

            .aspect-ratio-buttons {
                flex-direction: column;
            }

            .ratio-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¸ ç”»åƒåˆ‡ã‚ŠæŠœããƒ„ãƒ¼ãƒ«</h1>
            <p class="subtitle">1:1ã€16:9ã€9:16ã®3ç¨®é¡ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã§ä¸€æ‹¬åˆ‡ã‚ŠæŠœã</p>
        </header>

        <div class="upload-section" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                <div class="upload-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                <input type="file" id="fileInput" accept="image/*">
            </div>
        </div>

        <div class="editor-section" id="editorSection">
            <div class="controls">
                <div class="aspect-ratio-buttons">
                    <button class="ratio-btn active" data-ratio="1:1">1:1 (æ­£æ–¹å½¢)</button>
                    <button class="ratio-btn" data-ratio="16:9">16:9 (æ¨ªé•·)</button>
                    <button class="ratio-btn" data-ratio="9:16">9:16 (ç¸¦é•·)</button>
                </div>

                <div class="position-controls">
                    <div class="position-label">åˆ‡ã‚ŠæŠœãä½ç½®ã‚’èª¿æ•´</div>
                    <div class="slider-group">
                        <label for="posX">æ¨ªä½ç½®</label>
                        <input type="range" id="posX" min="0" max="100" value="50">
                    </div>
                    <div class="slider-group">
                        <label for="posY">ç¸¦ä½ç½®</label>
                        <input type="range" id="posY" min="0" max="100" value="50">
                    </div>
                    <div class="slider-group">
                        <label for="zoom">ã‚ºãƒ¼ãƒ </label>
                        <input type="range" id="zoom" min="10" max="100" value="100">
                    </div>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="preview-section">
                <div class="preview-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="preview-grid">
                    <div class="preview-item">
                        <div class="preview-label">1:1 (æ­£æ–¹å½¢)</div>
                        <canvas class="preview-canvas" id="preview1"></canvas>
                        <div class="size-display" id="size1"></div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">16:9 (æ¨ªé•·)</div>
                        <canvas class="preview-canvas" id="preview2"></canvas>
                        <div class="size-display" id="size2"></div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">9:16 (ç¸¦é•·)</div>
                        <canvas class="preview-canvas" id="preview3"></canvas>
                        <div class="size-display" id="size3"></div>
                    </div>
                </div>

                <div class="filename-input-group">
                    <label for="filenameInput">ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="filenameInput" placeholder="æœªè¨˜å…¥ã®å ´åˆã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="downloadBtn">ZIPã§ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn btn-primary" id="downloadIndividualBtn">3æšé€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn btn-secondary" id="newImageBtn">åˆ¥ã®ç”»åƒã‚’é¸æŠ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let originalImage = null;
        let originalFileName = '';
        let currentRatio = '1:1';
        let cropSettings = {
            '1:1': { x: 50, y: 50, zoom: 100 },
            '16:9': { x: 50, y: 50, zoom: 100 },
            '9:16': { x: 50, y: 50, zoom: 100 }
        };

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const editorSection = document.getElementById('editorSection');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const posXSlider = document.getElementById('posX');
        const posYSlider = document.getElementById('posY');
        const zoomSlider = document.getElementById('zoom');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadIndividualBtn = document.getElementById('downloadIndividualBtn');
        const newImageBtn = document.getElementById('newImageBtn');
        const filenameInput = document.getElementById('filenameInput');

        // ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã®å¤‰æ•°
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartPosX = 0;
        let dragStartPosY = 0;

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });

        // ç”»åƒèª­ã¿è¾¼ã¿
        function loadImage(file) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿å­˜ï¼ˆæ‹¡å¼µå­ãªã—ï¼‰
            originalFileName = file.name.replace(/\.[^/.]+$/, '');

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    uploadSection.style.display = 'none';
                    editorSection.classList.add('active');

                    // ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ›æ¬„ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    filenameInput.placeholder = `æœªè¨˜å…¥ã®å ´åˆã¯ "${originalFileName}" ã‚’ä½¿ç”¨`;

                    initCanvas();
                    updatePreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
        function initCanvas() {
            const maxWidth = editorSection.clientWidth - 80;
            const scale = maxWidth / originalImage.width;
            canvas.width = originalImage.width * scale;
            canvas.height = originalImage.height * scale;
            drawCanvas();
            setupCanvasDrag();
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‰ãƒ©ãƒƒã‚°è¨­å®š
        function setupCanvasDrag() {
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ãŒåˆ‡ã‚ŠæŠœãç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                const cropArea = calculateCropArea(currentRatio, canvas.width, canvas.height);
                if (x >= cropArea.x && x <= cropArea.x + cropArea.width &&
                    y >= cropArea.y && y <= cropArea.y + cropArea.height) {
                    isDragging = true;
                    dragStartX = x;
                    dragStartY = y;
                    dragStartPosX = cropSettings[currentRatio].x;
                    dragStartPosY = cropSettings[currentRatio].y;
                    canvas.style.cursor = 'grabbing';
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const deltaX = x - dragStartX;
                    const deltaY = y - dragStartY;

                    const cropArea = calculateCropArea(currentRatio, canvas.width, canvas.height);
                    const maxX = canvas.width - cropArea.width;
                    const maxY = canvas.height - cropArea.height;

                    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›
                    const newPosX = dragStartPosX + (deltaX / maxX) * 100;
                    const newPosY = dragStartPosY + (deltaY / maxY) * 100;

                    // ç¯„å›²åˆ¶é™
                    cropSettings[currentRatio].x = Math.max(0, Math.min(100, newPosX));
                    cropSettings[currentRatio].y = Math.max(0, Math.min(100, newPosY));

                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚æ›´æ–°
                    posXSlider.value = cropSettings[currentRatio].x;
                    posYSlider.value = cropSettings[currentRatio].y;

                    drawCanvas();
                    updatePreview();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            // åˆ‡ã‚ŠæŠœãç¯„å›²ã®è¡¨ç¤º
            const cropArea = calculateCropArea(currentRatio, canvas.width, canvas.height);

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.clearRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);

            // æ ç·š
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.strokeRect(cropArea.x, cropArea.y, cropArea.width, cropArea.height);

            // ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 1; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(cropArea.x + cropArea.width * i / 3, cropArea.y);
                ctx.lineTo(cropArea.x + cropArea.width * i / 3, cropArea.y + cropArea.height);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(cropArea.x, cropArea.y + cropArea.height * i / 3);
                ctx.lineTo(cropArea.x + cropArea.width, cropArea.y + cropArea.height * i / 3);
                ctx.stroke();
            }
        }

        // åˆ‡ã‚ŠæŠœãç¯„å›²è¨ˆç®—
        function calculateCropArea(ratio, canvasWidth, canvasHeight) {
            const settings = cropSettings[ratio];
            const zoomFactor = settings.zoom / 100;

            let width, height;
            const [w, h] = ratio.split(':').map(Number);
            const aspectRatio = w / h;

            if (canvasWidth / canvasHeight > aspectRatio) {
                height = canvasHeight * zoomFactor;
                width = height * aspectRatio;
            } else {
                width = canvasWidth * zoomFactor;
                height = width / aspectRatio;
            }

            const maxX = canvasWidth - width;
            const maxY = canvasHeight - height;
            const x = (maxX * settings.x / 100);
            const y = (maxY * settings.y / 100);

            return { x, y, width, height };
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updatePreview() {
            const ratios = ['1:1', '16:9', '9:16'];
            const previewCanvases = [
                document.getElementById('preview1'),
                document.getElementById('preview2'),
                document.getElementById('preview3')
            ];
            const sizeDisplays = [
                document.getElementById('size1'),
                document.getElementById('size2'),
                document.getElementById('size3')
            ];

            ratios.forEach((ratio, index) => {
                const previewCanvas = previewCanvases[index];
                const previewCtx = previewCanvas.getContext('2d');

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ã‚ºè¨­å®š
                const maxPreviewSize = 400;
                const [w, h] = ratio.split(':').map(Number);
                const aspectRatio = w / h;

                let previewWidth, previewHeight;
                if (aspectRatio > 1) {
                    previewWidth = maxPreviewSize;
                    previewHeight = maxPreviewSize / aspectRatio;
                } else {
                    previewHeight = maxPreviewSize;
                    previewWidth = maxPreviewSize * aspectRatio;
                }

                previewCanvas.width = previewWidth;
                previewCanvas.height = previewHeight;

                // åˆ‡ã‚ŠæŠœãç¯„å›²ã‚’è¨ˆç®—
                const settings = cropSettings[ratio];
                const zoomFactor = settings.zoom / 100;

                let cropWidth, cropHeight;
                if (originalImage.width / originalImage.height > aspectRatio) {
                    cropHeight = originalImage.height * zoomFactor;
                    cropWidth = cropHeight * aspectRatio;
                } else {
                    cropWidth = originalImage.width * zoomFactor;
                    cropHeight = cropWidth / aspectRatio;
                }

                const maxX = originalImage.width - cropWidth;
                const maxY = originalImage.height - cropHeight;
                const cropX = maxX * settings.x / 100;
                const cropY = maxY * settings.y / 100;

                // åˆ‡ã‚ŠæŠœã„ã¦æç”»
                previewCtx.drawImage(
                    originalImage,
                    cropX, cropY, cropWidth, cropHeight,
                    0, 0, previewWidth, previewHeight
                );

                // ã‚µã‚¤ã‚ºè¡¨ç¤º
                sizeDisplays[index].textContent = `${Math.round(cropWidth)} Ã— ${Math.round(cropHeight)} px`;
            });
        }

        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ãƒœã‚¿ãƒ³
        ratioButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                ratioButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentRatio = btn.dataset.ratio;

                // ç¾åœ¨ã®è¨­å®šã‚’å¾©å…ƒ
                const settings = cropSettings[currentRatio];
                posXSlider.value = settings.x;
                posYSlider.value = settings.y;
                zoomSlider.value = settings.zoom;

                drawCanvas();
            });
        });

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
        posXSlider.addEventListener('input', (e) => {
            cropSettings[currentRatio].x = parseInt(e.target.value);
            drawCanvas();
            updatePreview();
        });

        posYSlider.addEventListener('input', (e) => {
            cropSettings[currentRatio].y = parseInt(e.target.value);
            drawCanvas();
            updatePreview();
        });

        zoomSlider.addEventListener('input', (e) => {
            cropSettings[currentRatio].zoom = parseInt(e.target.value);
            drawCanvas();
            updatePreview();
        });

        // åˆ‡ã‚ŠæŠœãç”»åƒã‚’ç”Ÿæˆã™ã‚‹å…±é€šé–¢æ•°
        function generateCroppedImage(ratio, suffix) {
            const settings = cropSettings[ratio];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const [w, h] = ratio.split(':').map(Number);
            const aspectRatio = w / h;
            const zoomFactor = settings.zoom / 100;

            let cropWidth, cropHeight;
            if (originalImage.width / originalImage.height > aspectRatio) {
                cropHeight = originalImage.height * zoomFactor;
                cropWidth = cropHeight * aspectRatio;
            } else {
                cropWidth = originalImage.width * zoomFactor;
                cropHeight = cropWidth / aspectRatio;
            }

            canvas.width = cropWidth;
            canvas.height = cropHeight;

            const maxX = originalImage.width - cropWidth;
            const maxY = originalImage.height - cropHeight;
            const cropX = maxX * settings.x / 100;
            const cropY = maxY * settings.y / 100;

            ctx.drawImage(
                originalImage,
                cropX, cropY, cropWidth, cropHeight,
                0, 0, cropWidth, cropHeight
            );

            return canvas;
        }

        // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadBtn.addEventListener('click', async () => {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆæœªè¨˜å…¥ã®å ´åˆã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨ï¼‰
            let baseFileName = filenameInput.value.trim();
            if (!baseFileName) {
                baseFileName = originalFileName;
            }

            const zip = new JSZip();
            const ratios = ['1:1', '16:9', '9:16'];
            const suffixes = ['square', 'landscape', 'portrait'];

            for (let i = 0; i < ratios.length; i++) {
                const ratio = ratios[i];
                const suffix = suffixes[i];
                const canvas = generateCroppedImage(ratio, suffix);

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                zip.file(`${baseFileName}_${suffix}_${ratio.replace(':', 'x')}.png`, blob);
            }

            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${baseFileName}_cropped.zip`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // å€‹åˆ¥é€£ç¶šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        downloadIndividualBtn.addEventListener('click', async () => {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆæœªè¨˜å…¥ã®å ´åˆã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨ï¼‰
            let baseFileName = filenameInput.value.trim();
            if (!baseFileName) {
                baseFileName = originalFileName;
            }

            const ratios = ['1:1', '16:9', '9:16'];
            const suffixes = ['square', 'landscape', 'portrait'];

            for (let i = 0; i < ratios.length; i++) {
                const ratio = ratios[i];
                const suffix = suffixes[i];
                const canvas = generateCroppedImage(ratio, suffix);

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${baseFileName}_${suffix}_${ratio.replace(':', 'x')}.png`;
                a.click();
                URL.revokeObjectURL(url);

                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒå‡¦ç†ã§ãã‚‹ã‚ˆã†ã«å°‘ã—å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        });

        // æ–°ã—ã„ç”»åƒ
        newImageBtn.addEventListener('click', () => {
            editorSection.classList.remove('active');
            uploadSection.style.display = 'block';
            fileInput.value = '';
            originalImage = null;
            originalFileName = '';
            filenameInput.value = '';
            filenameInput.placeholder = 'æœªè¨˜å…¥ã®å ´åˆã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨';
            cropSettings = {
                '1:1': { x: 50, y: 50, zoom: 100 },
                '16:9': { x: 50, y: 50, zoom: 100 },
                '9:16': { x: 50, y: 50, zoom: 100 }
            };
            currentRatio = '1:1';
            ratioButtons.forEach((btn, i) => {
                if (i === 0) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        });
    </script>
</body>
</html>
